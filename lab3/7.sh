#!/bin/bash

# Выводит список IP-адресов и количество соединений с них к нашему хосту через заданный порт

PORT=${1:-22}  # порт по умолчанию 22

# Получаем установленные TCP-соединения через ss, фильтруем по локальному порту, считаем по IP
ss -tn state established "( sport = :$PORT or dport = :$PORT )" 2>/dev/null \
  | awk 'NR>1 { print $5 }' \
  | sed -E 's/$$[0-9:.]*$$/&/; s/:[0-9]+$//' \
  | sed 's/^$$//; s/$$$//' \
  | grep -v '^$' \
  | sort \
  | uniq -c \
  | sort -nr \
  | awk '{ printf "%s\t%s\n",$2,$1 }'
